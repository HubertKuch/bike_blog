<!DOCTYPE html>
<html lang="pl">
{{> head }}
<body>

{{> header }}

<main class="main-content">
    {{> admin_nav }}

    {{> banner_in_main }}

    <div class="news-container">

        <nav class="news-navigation">
            <div>
                <span>
                    Zalogowany jako {{ username }}.
                </span>
                <br>

                <span>
                    <a href="api/v1/users/logout">Wyloguj sie.</a>
                </span>
            </div>
        </nav>

        <div class="news">
            <h3>Panel administracyjny</h3>
            {{> newsForm }}
        </div>
    </div>
</main>

{{> footer }}

{{> scriptsSource }}

<script>
    const titleElement = document.querySelector("[name=title]");
    const descriptionElement = document.querySelector("[name=description]");
    const dateElement = document.querySelector("[name=date]");
    const submitButton = document.querySelector(".submit-news-form");
    const buttonAddMeter = document.querySelector(".add-button[data-add-action='add-meter']");
    const buttonAddTag = document.querySelector(".add-button[data-add-action='add-tag']");
    const metersContainer = document.querySelector(".meters");
    const tagsContainer = document.querySelector(".tags");
    const form = document.querySelector(".news-form");

    function getNewsBody() {
        return {
            title: titleElement.value,
            description: descriptionElement.innerHTML,
            date: dateElement.value
        };
    }

    function getMeterDataFromContainer(container) {
        return {
            maxSpeed: container.querySelector("[name='max-speed']").value,
            time: container.querySelector("[name=time]").value,
            meterStartState: container.querySelector("[name='meter-start-state']").value,
            meterEndState: container.querySelector("[name='meter-end-state']").value,
        };
    }

    function getTagsDataFromContainer(container) {
        return {
            tag: container.querySelector("[name='tag-name']"),
        };
    }

    /**
     * @param {News} news
     * @param {Meter[]} meters
     * */
    function showActualData({title, description, date}, meters, tags) {
        titleElement.value = title;
        descriptionElement.textContent = description;
        dateElement.value = date;
        submitButton.textContent = "ZAPISZ";

        meters.forEach(meter => new MeterElement(meter).render(metersContainer))
        tags.forEach(tag => new TagInnerFormElement().render(tagsContainer, tag.tag))
    }

    function addMeterHandler() {
        new MeterElement().render(metersContainer)
    }

    function addTagHandler() {
        new TagInnerFormElement().render(tagsContainer)
    }

    function buildNewsRequest() {
        const base = getNewsBody();

        base.tags = [...tagsContainer.querySelectorAll('.tag input')].map(tag => tag.value);

        return base;
    }

    function buildMetersRequest(newsId) {
        const meters = document.querySelectorAll(".meter");

        return [...meters].map(meter => {
            return {
                id: meter.querySelector("div").getAttribute("data-id"),
                maxSpeed: parseFloat(meter.querySelector("[name='max-speed']").value) ?? 0,
                startState: parseFloat(meter.querySelector("[name='meter-start-state']").value) ?? 0,
                tripLength: parseFloat(meter.querySelector("[name='trip-length']").value) ?? 0,
                endState: parseFloat(meter.querySelector("[name='meter-end-state']").value) ?? 0,
                time: parseFloat(meter.querySelector("[name='time']").value) ?? 0,
                newsId: newsId,
                description: '',
                toShow: true,
            }
        });
    }

    function buildTagsRequest() {
        return {"tags": [...document.querySelectorAll("input[name=tag-name]")].map(tag => tag.value)};
    }

    function saveData(newsId) {
        const newsRequestBody = buildNewsRequest();
        const metersRequestBody = buildMetersRequest(newsId);
        const tagsRequestBody = buildTagsRequest(newsId);

        NewsController.update(newsId, newsRequestBody);
        NewsController.putTags(newsId, tagsRequestBody);
        metersRequestBody.forEach(meter => MetersController.updateMeter(meter));
    }

    async function main() {
        const newsData = {{{news}}};
        const news = NewsSerializer.serializeSingleNews(newsData);
        const meters = await MetersController.getMetersForNews(news.id);
        const tags = await NewsController.getNewsTags(news.id);

        buttonAddMeter.addEventListener("click", addMeterHandler);
        buttonAddTag.addEventListener("click", addTagHandler);
        form.addEventListener("submit", (e) => {
            e.preventDefault();

            saveData(newsData.id);
        });

        showActualData(news, meters, tags);
    }

    main()

</script>

</body>
</html>
